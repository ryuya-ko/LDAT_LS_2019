# ??????????????????DAT LS?????????????????????????????????????????????
setwd('/Users/LOng/sengokuLab/study/LDAT_LS_2019/')

install.packages("gstat")
install.packages("spBayes")
install.packages("RColorBrewer")

library(gstat)
library(spBayes)
library(RColorBrewer)

## ???????????????????????????????????????
dat <- read.csv('data/dev/csv/house_price_raw.csv')
mdat <- read.csv('data/dev/csv/house_price_pred.csv')

dat[1:5,]
coordinates(dat) =~ px+py

mdat[1:5,]
coordinates(mdat)=~px+py
## ???????????????
### ??????????????????????????????????????????????????????

display.brewer.all()
nc   <- 8
cols <- rev(brewer.pal(n = nc, name = "RdYlBu"))
cuts<-c(-Inf, quantile(dat$price,probs=seq(0.1,0.9,0.1)), Inf)
spplot(dat, "price",cuts=cuts, col.regions = cols, col="transparent",cex=1.5) # ???????????????????????????

## ???????????????????????????
varioC    <-variogram(object=log(price)~tokyo+station,data=dat,cloud=T)
plot(varioC)                                # ?????????????????????

vario    <-variogram(object=log(price)~tokyo+station,data=dat)
plot(vario)                                 # ????????????????????????

mvario <- fit.variogram(object=vario, model=vgm(psill=0.04,model="Exp",range=0.04,nugget=0.01))
# ?????????????????????????????????(vgm??????????????????????????????????????????????????????????????????)
plot(vario,mvario)                          #????????????????????????

#automap???????????????????????????(??????????????????????????????????????????)


## Regression kriging
gmodel <- gstat(formula= log(price)~tokyo+station,data=dat, model=mvario) # ??????????????????
mpred  <- predict(gmodel,newdata=mdat)             # Regression kriging
# geostat?????????kriging, ?????????????????????????????????????????????????????????????????????
mdat@data$predRK<-exp(mpred$var1.pred)             # ?????????(????????????????????????)
mdat@data$varRK <-mpred$var1.var                   # ??????????????????

## Linear regression???????????????
lmodel <-lm(log(price)~tokyo+station,data=dat@data)# ??????
lmpred <-exp(predict(lmodel, newdata=mdat@data))
mdat@data$predLM<-lmpred                           # ?????????

## ?????????
nc   <- 10                                         # 10???????????????
cols <- rev(brewer.pal(n = nc, name = "RdYlBu"))   # ????????????????????????
rang <-range(mdat@data$predRK)                     # ?????????????????????????????????
cuts<-seq(rang[1],rang[2],len=nc-1)                # ???????????????????????????

spplot(mdat, "predRK",cuts=cuts, col.regions = cols, col="transparent",cex=1.9, pch=15) #kriging?????????
# ????????????????????????????????????cex??????????????????

spplot(mdat, "predLM",cuts=cuts, col.regions = cols, col="transparent",cex=1.9,pch=15) #?????????????????????
#hotspot?????????????????????????????????

#kriging??????????????????????????????????????????
rang <-range(mdat@data$varRK)                      # ?????????????????????????????????
cuts<-quantile(mdat@data$varRK,probs=seq(0,1,0.1)) # ???????????????????????????
spplot(mdat, "varRK",cuts=cuts, col.regions = cols, col="transparent",cex=2,pch=15)

## Leave-one-out cross validatio
### Regression kriging
predRK <-krige.cv(log(price)~tokyo+station,dat, mvario)
#gstat?????????, ??????????????????LOO
### Linear regression
predLM <-NULL
for(i in 1:(dim(dat)[1])){
  dsub  <-dat@data[-i,] #?????????????????????????????????
  msub  <-dat@data[ i,]
  lmod  <-lm(log(price)~tokyo+station,data=dsub)
  predlm<-predict(lmod,  newdata=msub)
  predLM<-c(predLM, predlm)
}

### ????????????
plot(predRK@data[,c("observed","var1.pred")],pch=20) #??????vs?????????, y=x?????????????????????
plot(log(dat@data$price),predLM,pch=20) #kriging????????????????????????

rmseLM <- sqrt(sum((predLM-log(dat@data$price))^2)/(dim(dat)[1]))
rmseLM
rmseRK <- sqrt(sum((predRK@data[,"observed"]-predRK@data[,"var1.pred"])^2)/(dim(dat)[1]))
rmseRK #RMSE??????????????????

